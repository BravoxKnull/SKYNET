<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYNET - Profile</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Auth Check Script -->
    <script>
        const user = JSON.parse(localStorage.getItem('user'))
        if (!user) {
            window.location.href = 'auth.html'
        }
    </script>

    <div class="app-container">
        <header class="header">
            <div class="logo-container">
                <img src="assets/images/Skynet_Terminator_logo.svg" alt="SKYNET Logo" class="logo">
                <h1>SKYNET</h1>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> Home
                </a>
                <div class="user-info">
                    <i class="fas fa-user"></i>
                    <span id="userDisplayName"></span>
                </div>
                <button id="logoutBtn" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </nav>
        </header>

        <main class="main-content">
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img id="avatarPreview" src="assets/images/default-avatar.svg" alt="Profile Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjY2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI1Ii8+PHBhdGggZD0iTTIwIDIxYTggOCAwIDAgMC0xNiAwIi8+PC9zdmc+'" />
                        <div class="avatar-upload">
                            <label for="avatarInput" class="upload-btn">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarInput" accept="image/*" hidden>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profileDisplayName"></h2>
                        <div class="status-selector">
                            <select id="statusSelect">
                                <option value="online">Online</option>
                                <option value="away">Away</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="profile-sections">
                    <section class="profile-section">
                        <h3>Profile Information</h3>
                        <div class="form-group">
                            <label for="bioInput">Bio</label>
                            <textarea id="bioInput" rows="3" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="customStatus">Custom Status</label>
                            <div class="status-input">
                                <input type="text" id="customStatus" placeholder="Set a custom status...">
                                <button id="emojiPicker" class="emoji-btn">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="profile-section">
                        <h3>Preferences</h3>
                        <div class="preferences-grid">
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="notificationsToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>Notifications</span>
                            </div>
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="soundToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>Sound</span>
                            </div>
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="voiceActivityToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>Voice Activity</span>
                            </div>
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="pushToTalkToggle">
                                    <span class="slider"></span>
                                </label>
                                <span>Push to Talk</span>
                            </div>
                        </div>
                    </section>

                    <section class="profile-section appearance-section">
                        <h2>Appearance</h2>
                        <div class="section-content">
                            <div class="theme-switch-container">
                                <span class="theme-switch-label">Dark Theme</span>
                                <label class="theme-switch">
                                    <input type="checkbox" id="themeSwitch">
                                    <span class="theme-slider">
                                        <i class="fas fa-sun theme-icon sun"></i>
                                        <i class="fas fa-moon theme-icon moon"></i>
                                    </span>
                                </label>
                                <span class="theme-switch-label">Light Theme</span>
                            </div>
                            
                            <div class="theme-preview">
                                <div class="preview-item">
                                    <h4>Primary Elements</h4>
                                    <p>Buttons, links, and important actions</p>
                                    <button class="control-btn">Sample Button</button>
                                </div>
                                <div class="preview-item">
                                    <h4>Text & Background</h4>
                                    <p>Main content and text elements</p>
                                    <div class="input-field">Sample Input</div>
                                </div>
                                <div class="preview-item">
                                    <h4>Cards & Containers</h4>
                                    <p>UI containers and cards</p>
                                    <div class="user-item">Sample Card</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="profile-section">
                        <h3>Account</h3>
                        <div class="account-info">
                            <p>Member since: <span id="memberSince"></span></p>
                            <p>Last login: <span id="lastLogin"></span></p>
                        </div>
                        <div class="account-actions">
                            <button id="changePasswordBtn" class="btn-secondary">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                            <button id="deleteAccountBtn" class="btn-danger">
                                <i class="fas fa-trash"></i> Delete Account
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://jvjlvzidmcwcshbeielf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2amx2emlkbWN3Y3NoYmVpZWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Nzg5ODksImV4cCI6MjA2NDI1NDk4OX0.pTuQXNNsnqLJhFbA6W47wNoTmLZq4Fw53xnUmZdEUUw'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        // Global variables
        let storedUser = null
        let originalAvatarSrc = null

        // Initialize profile page
        function initializeProfile() {
            // Get stored user data
            storedUser = JSON.parse(localStorage.getItem('user'))
            if (!storedUser) {
                console.log('No user in localStorage')
                window.location.href = 'auth.html'
                return
            }

            // Set user display name
            function setUserDisplay() {
                document.getElementById('userDisplayName').textContent = storedUser.displayName || 'User'
                document.getElementById('profileDisplayName').textContent = storedUser.displayName || 'User'
            }

            // Handle logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await supabase.auth.signOut()
                    localStorage.removeItem('user')
                    window.location.href = 'auth.html'
                } catch (error) {
                    console.error('Logout error:', error)
                    // Still clear local storage and redirect even if there's an error
                    localStorage.removeItem('user')
                    window.location.href = 'auth.html'
                }
            })

            // Load user profile data
            async function loadProfile() {
                try {
                    console.log('Loading profile...')
                    const { data, error } = await supabase
                        .from('users')
                        .select('*, user_settings(*)')
                        .eq('id', storedUser.id)
                        .single()

                    if (error) {
                        console.error('Database error:', error)
                        throw error
                    }

                    console.log('User data loaded:', data)

                    // Update profile fields with null checks
                    const avatarPreview = document.getElementById('avatarPreview')
                    const bioInput = document.getElementById('bioInput')
                    const statusSelect = document.getElementById('statusSelect')
                    const themeSwitch = document.getElementById('themeSwitch')
                    const customStatus = document.getElementById('customStatus')
                    const memberSince = document.getElementById('memberSince')
                    const lastLogin = document.getElementById('lastLogin')
                    const notificationsToggle = document.getElementById('notificationsToggle')
                    const soundToggle = document.getElementById('soundToggle')
                    const voiceActivityToggle = document.getElementById('voiceActivityToggle')
                    const pushToTalkToggle = document.getElementById('pushToTalkToggle')

                    if (data.avatar_url && avatarPreview) {
                        avatarPreview.src = data.avatar_url
                        originalAvatarSrc = data.avatar_url
                    }

                    if (bioInput) bioInput.value = data.bio || ''
                    if (statusSelect) statusSelect.value = data.status || 'online'
                    if (themeSwitch) themeSwitch.checked = data.theme === 'light'
                    if (memberSince) memberSince.textContent = new Date(data.created_at).toLocaleDateString()
                    if (lastLogin) lastLogin.textContent = new Date(data.last_login).toLocaleDateString()

                    // Update settings with null checks
                    if (data.user_settings) {
                        if (notificationsToggle) notificationsToggle.checked = data.user_settings.email_notifications
                        if (soundToggle) soundToggle.checked = data.user_settings.sound_enabled
                        if (voiceActivityToggle) voiceActivityToggle.checked = data.user_settings.voice_activity
                        if (pushToTalkToggle) pushToTalkToggle.checked = data.user_settings.push_to_talk
                        if (customStatus) customStatus.value = data.user_settings.custom_status || ''
                    }
                } catch (error) {
                    console.error('Error loading profile:', error)
                    showMessage('Error loading profile data: ' + (error.message || 'Unknown error'), 'error')
                }
            }

            // Initialize the page
            setUserDisplay()
            loadProfile()
        }

        // Start the initialization
        initializeProfile()

        // Handle avatar upload
        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            if (!storedUser) {
                console.error('No user data available')
                return
            }

            const file = e.target.files[0]
            if (!file) return

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
            if (!allowedTypes.includes(file.type)) {
                showMessage('Please upload a valid image file (JPEG, PNG, GIF, or WebP)', 'error')
                return
            }

            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024 // 5MB in bytes
            if (file.size > maxSize) {
                showMessage('Image size should be less than 5MB', 'error')
                return
            }

            try {
                // Show loading state
                const avatarPreview = document.getElementById('avatarPreview')
                avatarPreview.style.opacity = '0.5'

                // Create a unique file name
                const fileExt = file.name.split('.').pop()
                const fileName = `${storedUser.id}-${Date.now()}.${fileExt}`

                console.log('Uploading avatar...')
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    })

                if (uploadError) {
                    console.error('Upload error:', uploadError)
                    throw uploadError
                }

                console.log('Getting public URL...')
                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(fileName)

                console.log('Updating user profile...')
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        avatar_url: publicUrl
                    })
                    .eq('id', storedUser.id)

                if (updateError) {
                    console.error('Update error:', updateError)
                    throw updateError
                }

                // Update avatar with fade effect
                avatarPreview.src = publicUrl
                originalAvatarSrc = publicUrl
                avatarPreview.style.opacity = '1'
                avatarPreview.style.transition = 'opacity 0.3s ease'

                showMessage('Avatar updated successfully!', 'success')
            } catch (error) {
                console.error('Error uploading avatar:', error)
                // Restore original avatar
                const avatarPreview = document.getElementById('avatarPreview')
                avatarPreview.src = originalAvatarSrc
                avatarPreview.style.opacity = '1'
                
                let errorMessage = 'Error uploading avatar. Please try again.'
                if (error.message?.includes('row-level security policy')) {
                    errorMessage = 'Storage permission error. Please check your Supabase settings.'
                }
                showMessage(errorMessage, 'error')
            }
        })

        // Save profile changes
        async function saveProfile() {
            if (!storedUser) {
                console.error('No user data available')
                return
            }

            try {
                const bioInput = document.getElementById('bioInput')
                const statusSelect = document.getElementById('statusSelect')
                const themeSwitch = document.getElementById('themeSwitch')
                const customStatus = document.getElementById('customStatus')
                const notificationsToggle = document.getElementById('notificationsToggle')
                const soundToggle = document.getElementById('soundToggle')
                const voiceActivityToggle = document.getElementById('voiceActivityToggle')
                const pushToTalkToggle = document.getElementById('pushToTalkToggle')

                // Update user profile
                const updates = {
                    bio: bioInput ? bioInput.value : '',
                    status: statusSelect ? statusSelect.value : 'online',
                    theme: themeSwitch ? (themeSwitch.checked ? 'light' : 'dark') : 'dark'
                }

                console.log('Updating user profile with:', updates)
                const { error } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', storedUser.id)

                if (error) {
                    console.error('Error updating profile:', error)
                    throw error
                }

                // Update user settings
                const settings = {
                    user_id: storedUser.id,
                    email_notifications: notificationsToggle ? notificationsToggle.checked : true,
                    sound_enabled: soundToggle ? soundToggle.checked : true,
                    voice_activity: voiceActivityToggle ? voiceActivityToggle.checked : true,
                    push_to_talk: pushToTalkToggle ? pushToTalkToggle.checked : false,
                    custom_status: customStatus ? customStatus.value : ''
                }

                console.log('Updating user settings with:', settings)
                const { error: settingsError } = await supabase
                    .from('user_settings')
                    .upsert(settings)

                if (settingsError) {
                    console.error('Error updating settings:', settingsError)
                    throw settingsError
                }

                // Apply theme immediately
                if (themeSwitch) {
                    const newTheme = themeSwitch.checked ? 'light' : 'dark'
                    document.documentElement.setAttribute('data-theme', newTheme)
                    localStorage.setItem('theme', newTheme)
                }

                showMessage('Profile updated successfully!', 'success')
            } catch (error) {
                console.error('Error saving profile:', error)
                showMessage('Error saving profile changes: ' + (error.message || 'Unknown error'), 'error')
            }
        }

        // Helper function to show messages
        function showMessage(message, type = 'info') {
            const messageElement = document.createElement('div')
            messageElement.className = `${type}-message`
            messageElement.textContent = message
            messageElement.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};
                color: ${type === 'success' ? 'var(--secondary-color)' : 'white'};
                padding: 10px 20px;
                border-radius: 4px;
                animation: fadeOut 3s forwards;
                z-index: 1000;
            `
            document.body.appendChild(messageElement)
            setTimeout(() => messageElement.remove(), 3000)
        }

        // Add CSS for animations
        const style = document.createElement('style')
        style.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; }
                70% { opacity: 1; }
                100% { opacity: 0; }
            }
        `
        document.head.appendChild(style)

        // Handle password change
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const newPassword = prompt('Enter new password:')
            if (!newPassword) return

            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                })

                if (error) throw error
                alert('Password updated successfully!')
            } catch (error) {
                console.error('Error changing password:', error)
                alert('Error changing password')
            }
        })

        // Handle account deletion
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return

            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', storedUser.id)

                if (error) throw error

                await supabase.auth.signOut()
                localStorage.removeItem('user')
                window.location.href = 'auth.html'
            } catch (error) {
                console.error('Error deleting account:', error)
                alert('Error deleting account')
            }
        })

        // Save changes when inputs change
        const saveInputs = document.querySelectorAll('input, select, textarea')
        saveInputs.forEach(input => {
            if (input) {
                input.addEventListener('change', () => {
                    // Add a small delay to prevent multiple rapid saves
                    clearTimeout(window.saveTimeout)
                    window.saveTimeout = setTimeout(saveProfile, 500)
                })
            }
        })
    </script>

    <style>
    .profile-section {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
    }

    .profile-section h2 {
        color: var(--text-color);
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .section-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .appearance-section {
        max-width: 800px;
        margin: 0 auto;
    }
    </style>
</body>
</html> 