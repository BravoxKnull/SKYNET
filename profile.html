<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYNET - Profile</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Auth Check Script -->
    <script>
        const user = JSON.parse(localStorage.getItem('user'))
        if (!user) {
            window.location.href = 'auth.html'
        }
    </script>

    <div class="app-container">
        <header class="header">
            <div class="logo-container">
                <img src="assets/images/logo.svg" alt="SKYNET Logo" class="logo">
                <h1>SKYNET</h1>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> Home
                </a>
                <div class="user-info">
                    <i class="fas fa-user"></i>
                    <span id="userDisplayName"></span>
                </div>
                <button id="logoutBtn" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </nav>
        </header>

        <main class="main-content">
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img id="avatarPreview" src="assets/images/default-avatar.svg" alt="Profile Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjY2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI1Ii8+PHBhdGggZD0iTTIwIDIxYTggOCAwIDAgMC0xNiAwIi8+PC9zdmc+'" />
                        <div class="avatar-upload">
                            <label for="avatarInput" class="upload-btn">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarInput" accept="image/*" hidden>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profileDisplayName"></h2>
                        <div class="status-selector">
                            <select id="statusSelect">
                                <option value="online">Online</option>
                                <option value="away">Away</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="profile-sections">
                    <section class="profile-section">
                        <h3>Profile Information</h3>
                        <div class="form-group">
                            <label for="bioInput">Bio</label>
                            <textarea id="bioInput" rows="3" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="customStatus">Custom Status</label>
                            <div class="status-input">
                                <input type="text" id="customStatus" placeholder="Set a custom status...">
                                <button id="emojiPicker" class="emoji-btn">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="profile-section">
                        <h3>Preferences</h3>
                        <div class="preferences-grid">
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="notificationsToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>Notifications</span>
                            </div>
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="soundToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>Sound</span>
                            </div>
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="voiceActivityToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>Voice Activity</span>
                            </div>
                            <div class="preference-item">
                                <label class="switch">
                                    <input type="checkbox" id="pushToTalkToggle">
                                    <span class="slider"></span>
                                </label>
                                <span>Push to Talk</span>
                            </div>
                        </div>
                    </section>

                    <section class="profile-section">
                        <h3>Appearance</h3>
                        <div class="form-group">
                            <label for="themeSelect">Theme</label>
                            <select id="themeSelect">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="languageSelect">Language</label>
                            <select id="languageSelect">
                                <option value="en">English</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                                <option value="de">Deutsch</option>
                            </select>
                        </div>
                    </section>

                    <section class="profile-section">
                        <h3>Account</h3>
                        <div class="account-info">
                            <p>Member since: <span id="memberSince"></span></p>
                            <p>Last login: <span id="lastLogin"></span></p>
                        </div>
                        <div class="account-actions">
                            <button id="changePasswordBtn" class="btn-secondary">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                            <button id="deleteAccountBtn" class="btn-danger">
                                <i class="fas fa-trash"></i> Delete Account
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://jvjlvzidmcwcshbeielf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2amx2emlkbWN3Y3NoYmVpZWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Nzg5ODksImV4cCI6MjA2NDI1NDk4OX0.pTuQXNNsnqLJhFbA6W47wNoTmLZq4Fw53xnUmZdEUUw'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        // Get stored user data
        const storedUser = JSON.parse(localStorage.getItem('user'))
        if (!storedUser) {
            console.log('No user in localStorage, redirecting to auth')
            window.location.href = 'auth.html'
        }

        // Check authentication and redirect if not authenticated
        async function checkAuth() {
            try {
                console.log('Checking authentication...')
                
                // First check if we have a stored session
                const storedUser = JSON.parse(localStorage.getItem('user'))
                if (!storedUser || !storedUser.session) {
                    console.log('No stored session found')
                    return null
                }

                // Try to get current session
                const { data: { session }, error } = await supabase.auth.getSession()
                
                if (error) {
                    console.error('Auth error:', error)
                    return null
                }

                if (!session) {
                    console.log('No active session, trying to refresh...')
                    // Try to refresh the session
                    const { data: { session: refreshedSession }, error: refreshError } = await supabase.auth.refreshSession()
                    
                    if (refreshError || !refreshedSession) {
                        console.log('Failed to refresh session')
                        return null
                    }
                    
                    // Update stored session
                    storedUser.session = refreshedSession
                    localStorage.setItem('user', JSON.stringify(storedUser))
                    return refreshedSession
                }

                console.log('Session found:', session)
                return session
            } catch (error) {
                console.error('Auth check error:', error)
                return null
            }
        }

        // Set user display name
        async function setUserDisplay() {
            try {
                const storedUser = JSON.parse(localStorage.getItem('user'))
                if (!storedUser) {
                    console.log('No stored user data')
                    window.location.href = 'auth.html'
                    return
                }

                // Set display name from localStorage first
                document.getElementById('userDisplayName').textContent = storedUser.displayName || 'User'
                document.getElementById('profileDisplayName').textContent = storedUser.displayName || 'User'

                // Then verify with Supabase
                const session = await checkAuth()
                if (!session) {
                    console.log('No valid session found, redirecting to auth')
                    window.location.href = 'auth.html'
                    return
                }

                const { data: { user }, error } = await supabase.auth.getUser()
                if (error || !user) {
                    console.error('User fetch error:', error)
                    window.location.href = 'auth.html'
                    return
                }

                // Update display name if different from Supabase
                const displayName = user.user_metadata?.display_name || user.email || storedUser.displayName || 'User'
                document.getElementById('userDisplayName').textContent = displayName
                document.getElementById('profileDisplayName').textContent = displayName
            } catch (error) {
                console.error('Display name error:', error)
                window.location.href = 'auth.html'
            }
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut()
            localStorage.removeItem('user')
            window.location.href = 'auth.html'
        })

        // Load user profile data
        async function loadProfile() {
            try {
                console.log('Loading profile...')
                const session = await checkAuth()
                if (!session) {
                    console.log('No session in loadProfile')
                    return
                }

                console.log('Fetching user data from database...')
                const { data, error } = await supabase
                    .from('users')
                    .select('*, user_settings(*)')
                    .eq('id', session.user.id)
                    .single()

                if (error) {
                    console.error('Database error:', error)
                    throw error
                }

                console.log('User data loaded:', data)

                // Update profile fields
                if (data.avatar_url) {
                    document.getElementById('avatarPreview').src = data.avatar_url
                }
                document.getElementById('bioInput').value = data.bio || ''
                document.getElementById('statusSelect').value = data.status
                document.getElementById('themeSelect').value = data.theme
                document.getElementById('languageSelect').value = data.language
                document.getElementById('memberSince').textContent = new Date(data.created_at).toLocaleDateString()
                document.getElementById('lastLogin').textContent = new Date(data.last_login).toLocaleDateString()

                // Update settings
                if (data.user_settings) {
                    document.getElementById('notificationsToggle').checked = data.user_settings.email_notifications
                    document.getElementById('soundToggle').checked = data.user_settings.sound_enabled
                    document.getElementById('voiceActivityToggle').checked = data.user_settings.voice_activity
                    document.getElementById('pushToTalkToggle').checked = data.user_settings.push_to_talk
                    document.getElementById('customStatus').value = data.user_settings.custom_status || ''
                }
            } catch (error) {
                console.error('Error loading profile:', error)
            }
        }

        // Save profile changes
        async function saveProfile() {
            try {
                const session = await checkAuth()
                if (!session) {
                    console.error('No session available for saving profile')
                    return
                }

                const updates = {
                    bio: document.getElementById('bioInput').value,
                    status: document.getElementById('statusSelect').value,
                    theme: document.getElementById('themeSelect').value,
                    language: document.getElementById('languageSelect').value
                }

                const { error } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', session.user.id)

                if (error) {
                    console.error('Error updating profile:', error)
                    throw error
                }

                // Update settings
                const settings = {
                    user_id: session.user.id,
                    email_notifications: document.getElementById('notificationsToggle').checked,
                    sound_enabled: document.getElementById('soundToggle').checked,
                    voice_activity: document.getElementById('voiceActivityToggle').checked,
                    push_to_talk: document.getElementById('pushToTalkToggle').checked,
                    custom_status: document.getElementById('customStatus').value
                }

                const { error: settingsError } = await supabase
                    .from('user_settings')
                    .upsert(settings)

                if (settingsError) {
                    console.error('Error updating settings:', settingsError)
                    throw settingsError
                }

                alert('Profile updated successfully!')
            } catch (error) {
                console.error('Error saving profile:', error)
                alert('Error saving profile changes')
            }
        }

        // Handle avatar upload
        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]
            if (!file) return

            try {
                const session = await checkAuth()
                if (!session) {
                    console.error('No session available for avatar upload')
                    return
                }

                const fileExt = file.name.split('.').pop()
                const fileName = `${session.user.id}-${Math.random()}.${fileExt}`
                const filePath = `${session.user.id}/${fileName}`

                console.log('Uploading avatar...')
                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true
                    })

                if (uploadError) {
                    console.error('Upload error:', uploadError)
                    throw uploadError
                }

                console.log('Getting public URL...')
                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath)

                console.log('Updating user profile...')
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ avatar_url: publicUrl })
                    .eq('id', session.user.id)

                if (updateError) {
                    console.error('Update error:', updateError)
                    throw updateError
                }

                document.getElementById('avatarPreview').src = publicUrl
                alert('Avatar updated successfully!')
            } catch (error) {
                console.error('Error uploading avatar:', error)
                alert('Error uploading avatar')
            }
        })

        // Handle password change
        document.getElementById('changePasswordBtn').addEventListener('click', async () => {
            const newPassword = prompt('Enter new password:')
            if (!newPassword) return

            try {
                const session = await checkAuth()
                if (!session) return

                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                })

                if (error) throw error
                alert('Password updated successfully!')
            } catch (error) {
                console.error('Error changing password:', error)
                alert('Error changing password')
            }
        })

        // Handle account deletion
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return

            try {
                const session = await checkAuth()
                if (!session) return

                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', session.user.id)

                if (error) throw error

                await supabase.auth.signOut()
                localStorage.removeItem('user')
                window.location.href = 'auth.html'
            } catch (error) {
                console.error('Error deleting account:', error)
                alert('Error deleting account')
            }
        })

        // Initialize page
        async function initPage() {
            try {
                console.log('Initializing page...')
                await setUserDisplay()
                await loadProfile()
            } catch (error) {
                console.error('Page init error:', error)
            }
        }

        // Start initialization
        console.log('Starting page initialization...')
        initPage()

        // Save changes when inputs change
        const saveInputs = document.querySelectorAll('input, select, textarea')
        saveInputs.forEach(input => {
            input.addEventListener('change', saveProfile)
        })
    </script>
</body>
</html> 