<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKYNET Servers</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #202225;
            --sidebar2-bg: #23272a;
            --main-bg: #36393f;
            --members-bg: #23272a;
            --neon: #a370f7;
            --neon2: #0db9d7;
            --danger: #ff6b6b;
            --success: #7bc043;
            --text: #e0e0e0;
            --glass: rgba(36, 37, 54, 0.85);
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Rajdhani', 'Orbitron', sans-serif;
            background: var(--main-bg);
            color: var(--text);
            overflow: hidden;
        }
        .servers-root {
            display: grid;
            grid-template-columns: 72px 240px 1fr 300px;
            grid-template-rows: 100vh;
            height: 100vh;
            width: 100vw;
            background: var(--main-bg);
        }
        /* 1️⃣ Left Sidebar (Server List) */
        .server-sidebar {
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 12px;
            border-right: 1.5px solid var(--glass);
        }
        .server-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--glass);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.7rem;
            color: var(--neon);
            box-shadow: 0 0 0 0 var(--neon2);
            transition: box-shadow 0.2s, transform 0.2s;
            cursor: pointer;
            position: relative;
        }
        .server-icon:hover, .server-icon.active {
            box-shadow: 0 0 16px 4px var(--neon2), 0 0 0 2px var(--neon);
            transform: scale(1.08);
            z-index: 2;
        }
        .server-tooltip {
            display: none;
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--glass);
            color: var(--text);
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.98rem;
            white-space: nowrap;
            box-shadow: 0 2px 12px #0008;
        }
        .server-icon:hover .server-tooltip {
            display: block;
        }
        .server-add {
            margin-top: auto;
            margin-bottom: 8px;
            background: var(--neon2);
            color: #fff;
            font-size: 2rem;
            box-shadow: 0 0 12px 2px var(--neon2);
        }
        .server-explore {
            margin-bottom: 8px;
            background: var(--glass);
            color: var(--neon2);
            font-size: 1.5rem;
        }
        /* 2️⃣ Second Sidebar (Channel List) */
        .channel-sidebar {
            background: var(--sidebar2-bg);
            display: flex;
            flex-direction: column;
            height: 100vh;
            border-right: 1.5px solid var(--glass);
            min-width: 0;
        }
        .server-header {
            padding: 18px 18px 10px 18px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.18rem;
            font-weight: 700;
            color: var(--neon);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass);
        }
        .server-header .dropdown {
            font-size: 1.2rem;
            color: var(--text);
            cursor: pointer;
        }
        .channels-section {
            margin-top: 18px;
            flex: 1;
            overflow-y: auto;
            padding: 0 8px 0 0;
        }
        .channels-group {
            margin-bottom: 18px;
        }
        .channels-group-title {
            font-size: 0.98rem;
            color: var(--neon2);
            margin: 0 0 6px 18px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .channel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 18px;
            border-radius: 8px;
            color: var(--text);
            font-size: 1.08rem;
            cursor: pointer;
            margin-bottom: 2px;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
            position: relative;
        }
        .channel-item.active {
            background: var(--glass);
            color: var(--neon);
            box-shadow: 0 0 8px 2px var(--neon2);
        }
        .channel-item:hover {
            background: #292b2f;
            color: var(--neon2);
        }
        .channel-icon {
            font-size: 1.1rem;
        }
        .create-channel-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 18px 18px 0 18px;
            padding: 8px 0;
            color: var(--neon2);
            background: none;
            border: none;
            font-size: 1.05rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.18s, color 0.18s;
        }
        .create-channel-btn:hover {
            background: var(--glass);
            color: var(--neon);
        }
        .no-channels {
            margin: 32px 18px;
            padding: 24px;
            background: var(--glass);
            border-radius: 14px;
            text-align: center;
            color: var(--neon2);
            font-size: 1.1rem;
            font-family: 'Rajdhani', sans-serif;
            box-shadow: 0 0 12px 2px var(--neon2)33;
        }
        /* 3️⃣ Main Panel (Chat/Voice UI) */
        .main-panel {
            background: var(--main-bg);
            display: flex;
            flex-direction: column;
            height: 100vh;
            min-width: 0;
            position: relative;
        }
        .main-topbar {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: var(--glass);
            border-bottom: 1px solid var(--glass);
            font-size: 1.15rem;
            color: var(--neon2);
            font-family: 'Orbitron', sans-serif;
        }
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px 24px 24px 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .message {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 8px;
        }
        .message-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--glass);
            object-fit: cover;
        }
        .message-body {
            background: var(--glass);
            border-radius: 10px;
            padding: 10px 16px;
            color: var(--text);
            font-size: 1.04rem;
            box-shadow: 0 2px 8px #0002;
            min-width: 0;
        }
        .message-user {
            font-weight: 700;
            color: var(--neon2);
            font-size: 1.01rem;
        }
        .message-time {
            font-size: 0.85rem;
            color: #aaa;
            margin-left: 8px;
        }
        .message-input-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 24px;
            background: var(--glass);
            border-top: 1px solid var(--glass);
        }
        .message-input {
            flex: 1;
            background: #23272a;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 1.05rem;
            outline: none;
        }
        .input-action {
            background: none;
            border: none;
            color: var(--neon2);
            font-size: 1.3rem;
            cursor: pointer;
            margin-left: 4px;
            transition: color 0.18s;
        }
        .input-action:hover {
            color: var(--neon);
        }
        /* Voice Channel UI */
        .voice-users-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            padding: 32px 0 0 0;
        }
        .voice-user {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 90px;
        }
        .voice-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--glass);
            border: 3px solid transparent;
            box-shadow: 0 0 0 0 var(--neon2);
            transition: border 0.2s, box-shadow 0.2s;
        }
        .voice-user.speaking .voice-avatar {
            border: 3px solid var(--neon2);
            box-shadow: 0 0 16px 4px var(--neon2);
        }
        .voice-username {
            color: var(--neon2);
            font-size: 1.01rem;
            font-family: 'Rajdhani', sans-serif;
        }
        .voice-controls {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-top: 24px;
        }
        .voice-btn {
            background: var(--glass);
            color: var(--neon2);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
        }
        .voice-btn:hover {
            background: var(--neon2);
            color: #fff;
            box-shadow: 0 0 12px 2px var(--neon2);
        }
        .voice-btn.danger {
            background: var(--danger);
            color: #fff;
        }
        /* 4️⃣ Right Sidebar (Members List) */
        .members-sidebar {
            background: var(--members-bg);
            border-left: 1.5px solid var(--glass);
            display: flex;
            flex-direction: column;
            height: 100vh;
            min-width: 0;
            padding: 0 0 0 0;
        }
        .members-header {
            padding: 18px 18px 10px 18px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--neon2);
            border-bottom: 1px solid var(--glass);
        }
        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 18px 0 0 0;
        }
        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 18px;
            border-radius: 8px;
            margin-bottom: 2px;
            color: var(--text);
            font-size: 1.01rem;
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
        }
        .member-item:hover {
            background: var(--glass);
            color: var(--neon2);
        }
        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--glass);
            object-fit: cover;
        }
        .member-role {
            font-size: 0.88rem;
            color: var(--neon);
            font-family: 'Rajdhani', sans-serif;
            margin-left: auto;
        }
        .member-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            margin-right: 4px;
        }
        .member-item.idle .member-status {
            background: #feca57;
        }
        .member-item.offline .member-status {
            background: #888;
        }
        /* Responsive */
        @media (max-width: 1100px) {
            .servers-root {
                grid-template-columns: 56px 180px 1fr 0px;
            }
            .members-sidebar {
                display: none;
            }
        }
        @media (max-width: 700px) {
            .servers-root {
                grid-template-columns: 48px 0px 1fr 0px;
            }
            .channel-sidebar, .members-sidebar {
                display: none;
            }
        }
        /* Modals, Animations, etc. can be added here */
    </style>
</head>
<body>
<div class="servers-root">
    <!-- 1️⃣ Server List Sidebar -->
    <aside class="server-sidebar">
        <div class="server-icon active" title="SKYNET HQ">
            <i class="fas fa-robot"></i>
            <span class="server-tooltip">SKYNET HQ</span>
        </div>
        <div class="server-icon" title="Gaming Room">
            <i class="fas fa-gamepad"></i>
            <span class="server-tooltip">Gaming Room</span>
        </div>
        <div class="server-icon" title="Study Group">
            <i class="fas fa-book"></i>
            <span class="server-tooltip">Study Group</span>
        </div>
        <div class="server-icon server-explore" title="Explore Servers">
            <i class="fas fa-compass"></i>
            <span class="server-tooltip">Explore Public Servers</span>
        </div>
        <div class="server-icon server-add" title="Add Server">
            <i class="fas fa-plus"></i>
            <span class="server-tooltip">Add Server</span>
        </div>
    </aside>
    <!-- 2️⃣ Channel List Sidebar -->
    <aside class="channel-sidebar">
        <div class="server-header">
            SKYNET HQ
            <span class="dropdown"><i class="fas fa-chevron-down"></i></span>
        </div>
        <div class="channels-section">
            <div class="channels-group">
                <div class="channels-group-title">TEXT CHANNELS</div>
                <div class="channel-item active"><span class="channel-icon">#</span> general</div>
                <div class="channel-item"><span class="channel-icon">#</span> memes</div>
            </div>
            <div class="channels-group">
                <div class="channels-group-title">VOICE CHANNELS</div>
                <div class="channel-item"><span class="channel-icon"><i class="fas fa-volume-up"></i></span> Voice 1</div>
                <div class="channel-item"><span class="channel-icon"><i class="fas fa-volume-up"></i></span> Music</div>
            </div>
            <button class="create-channel-btn"><i class="fas fa-plus"></i> Create Channel</button>
        </div>
    </aside>
    <!-- 3️⃣ Main Panel -->
    <main class="main-panel">
        <div class="main-topbar">
            #general
            <div>
                <i class="fas fa-bell"></i>
                <i class="fas fa-users" style="margin-left:18px;"></i>
            </div>
        </div>
        <div class="main-content" id="mainContent">
            <!-- Chat messages (for text channel) -->
            <div class="message">
                <img class="message-avatar" src="assets/images/default-avatar.svg" alt="User">
                <div>
                    <div class="message-user">MoonKnight <span class="message-time">10:32</span></div>
                    <div class="message-body">Welcome to the new SKYNET server page! 🎉</div>
                </div>
            </div>
            <div class="message">
                <img class="message-avatar" src="assets/images/default-avatar.svg" alt="User">
                <div>
                    <div class="message-user">Flame <span class="message-time">10:33</span></div>
                    <div class="message-body">This is a Discord-style UI, fully themed and ready for backend integration.</div>
                </div>
            </div>
        </div>
        <form class="message-input-bar" onsubmit="event.preventDefault();">
            <button class="input-action" title="Emoji"><i class="far fa-smile"></i></button>
            <input class="message-input" type="text" placeholder="Message #general...">
            <button class="input-action" title="Upload"><i class="fas fa-paperclip"></i></button>
            <button class="input-action" title="Send"><i class="fas fa-paper-plane"></i></button>
        </form>
    </main>
    <!-- 4️⃣ Members Sidebar -->
    <aside class="members-sidebar">
        <div class="members-header">Online — 2</div>
        <div class="members-list">
            <div class="member-item">
                <span class="member-status"></span>
                <img class="member-avatar" src="assets/images/default-avatar.svg" alt="User">
                <span class="member-name">MoonKnight</span>
                <span class="member-role">Admin</span>
            </div>
            <div class="member-item idle">
                <span class="member-status"></span>
                <img class="member-avatar" src="assets/images/default-avatar.svg" alt="User">
                <span class="member-name">Flame</span>
                <span class="member-role">Member</span>
            </div>
        </div>
    </aside>
</div>
<!-- Modals, JS, and backend integration will be added next -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Supabase Setup ---
const supabaseUrl = 'https://jvjlvzidmcwcshbeielf.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2amx2emlkbWN3Y3NoYmVpZWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2Nzg5ODksImV4cCI6MjA2NDI1NDk4OX0.pTuQXNNsnqLJhFbA6W47wNoTmLZq4Fw53xnUmZdEUUw';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- User Check ---
let user = JSON.parse(localStorage.getItem('user'));
if (!user) {
    window.location.href = 'auth.html';
}

// --- State ---
let servers = [];
let currentServerId = null;
let channels = [];
let currentChannelId = null;

// --- DOM Elements ---
const serverSidebar = document.querySelector('.server-sidebar');
const channelSidebar = document.querySelector('.channel-sidebar');
const mainPanel = document.querySelector('.main-panel');

// --- Fetch and Render Servers ---
async function loadServers() {
    // Fetch servers the user is a member of
    const { data, error } = await supabase
        .from('server_members')
        .select('server_id, servers(id, name, icon_url)')
        .eq('user_id', user.id);
    if (error) {
        console.error('Error loading servers:', error);
        return;
    }
    servers = (data || []).map(row => row.servers);
    renderServerSidebar();
    if (servers.length > 0) {
        selectServer(servers[0].id);
    }
}

function renderServerSidebar() {
    serverSidebar.innerHTML = '';
    servers.forEach((srv, idx) => {
        const div = document.createElement('div');
        div.className = 'server-icon' + (srv.id === currentServerId ? ' active' : '');
        div.title = srv.name;
        div.innerHTML = srv.icon_url
            ? `<img src="${srv.icon_url}" alt="${srv.name}" style="width:32px;height:32px;border-radius:50%;">`
            : `<i class="fas fa-robot"></i>`;
        const tooltip = document.createElement('span');
        tooltip.className = 'server-tooltip';
        tooltip.textContent = srv.name;
        div.appendChild(tooltip);
        div.onclick = () => selectServer(srv.id);
        serverSidebar.appendChild(div);
    });
    // Explore and Add Server buttons
    const explore = document.createElement('div');
    explore.className = 'server-icon server-explore';
    explore.title = 'Explore Servers';
    explore.innerHTML = '<i class="fas fa-compass"></i><span class="server-tooltip">Explore Public Servers</span>';
    serverSidebar.appendChild(explore);
    const add = document.createElement('div');
    add.className = 'server-icon server-add';
    add.title = 'Add Server';
    add.innerHTML = '<i class="fas fa-plus"></i><span class="server-tooltip">Add Server</span>';
    add.onclick = openAddServerModal;
    serverSidebar.appendChild(add);
}

function selectServer(serverId) {
    currentServerId = serverId;
    renderServerSidebar();
    loadChannels(serverId);
}

// --- Fetch and Render Channels ---
async function loadChannels(serverId) {
    // Fetch channels for this server
    const { data, error } = await supabase
        .from('channels')
        .select('*')
        .eq('server_id', serverId)
        .order('created_at', { ascending: true });
    if (error) {
        console.error('Error loading channels:', error);
        return;
    }
    channels = data || [];
    renderChannelSidebar();
    if (channels.length > 0) {
        selectChannel(channels[0].id);
    } else {
        selectChannel(null);
    }
}

function renderChannelSidebar() {
    const header = channelSidebar.querySelector('.server-header');
    header.textContent = servers.find(s => s.id === currentServerId)?.name || '';
    // Add dropdown for owned servers
    const dropdown = document.createElement('span');
    dropdown.className = 'dropdown';
    dropdown.innerHTML = '<i class="fas fa-chevron-down"></i>';
    const owned = serverIsOwned(currentServerId);
    if (owned) {
        dropdown.style.cursor = 'pointer';
        dropdown.onclick = (e) => {
            e.stopPropagation();
            openInviteCodeModal(currentServerId);
        };
        header.appendChild(dropdown);
    }
    // Remove old channels-section
    let section = channelSidebar.querySelector('.channels-section');
    if (section) section.remove();
    section = document.createElement('div');
    section.className = 'channels-section';
    // Group channels by type
    const textChannels = channels.filter(c => c.type === 'text');
    const voiceChannels = channels.filter(c => c.type === 'voice');
    // Text Channels
    const textGroup = document.createElement('div');
    textGroup.className = 'channels-group';
    const textTitle = document.createElement('div');
    textTitle.className = 'channels-group-title';
    textTitle.textContent = 'TEXT CHANNELS';
    textGroup.appendChild(textTitle);
    if (textChannels.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'no-channels';
        empty.innerHTML = '<i class="fas fa-hashtag" style="font-size:2rem;"></i><br>No text channels yet.<br><button class="create-channel-btn" style="margin-top:1rem;">Create Channel</button>';
        empty.querySelector('button').onclick = openCreateChannelModal;
        textGroup.appendChild(empty);
    } else {
        textChannels.forEach(c => {
            const item = document.createElement('div');
            item.className = 'channel-item' + (c.id === currentChannelId ? ' active' : '');
            item.innerHTML = '<span class="channel-icon">#</span> ' + c.name;
            item.onclick = () => selectChannel(c.id);
            textGroup.appendChild(item);
        });
    }
    section.appendChild(textGroup);
    // Voice Channels
    const voiceGroup = document.createElement('div');
    voiceGroup.className = 'channels-group';
    const voiceTitle = document.createElement('div');
    voiceTitle.className = 'channels-group-title';
    voiceTitle.textContent = 'VOICE CHANNELS';
    voiceGroup.appendChild(voiceTitle);
    if (voiceChannels.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'no-channels';
        empty.innerHTML = '<i class="fas fa-volume-up" style="font-size:2rem;"></i><br>No voice channels yet.<br><button class="create-channel-btn" style="margin-top:1rem;">Create Channel</button>';
        empty.querySelector('button').onclick = openCreateChannelModal;
        voiceGroup.appendChild(empty);
    } else {
        voiceChannels.forEach(c => {
            const item = document.createElement('div');
            item.className = 'channel-item' + (c.id === currentChannelId ? ' active' : '');
            item.innerHTML = '<span class="channel-icon"><i class="fas fa-volume-up"></i></span> ' + c.name;
            item.onclick = () => selectChannel(c.id);
            voiceGroup.appendChild(item);
        });
    }
    section.appendChild(voiceGroup);
    // Create Channel button
    const createBtn = document.createElement('button');
    createBtn.className = 'create-channel-btn';
    createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Channel';
    createBtn.onclick = openCreateChannelModal;
    section.appendChild(createBtn);
    channelSidebar.appendChild(section);
}

function selectChannel(channelId) {
    currentChannelId = channelId;
    renderChannelSidebar();
    // TODO: Load main panel for this channel
}

// --- Create Channel Modal ---
function openCreateChannelModal() {
    if (document.getElementById('createChannelModal')) return;
    const modal = document.createElement('div');
    modal.id = 'createChannelModal';
    modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(20,20,30,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div style="background:var(--glass);padding:2.2rem 2rem;border-radius:18px;box-shadow:0 8px 40px #000b;min-width:320px;max-width:90vw;position:relative;">
        <button onclick="document.getElementById('createChannelModal').remove()" style="position:absolute;top:18px;right:24px;background:none;border:none;font-size:1.5rem;color:var(--neon2);cursor:pointer;">&times;</button>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:1.2rem;color:var(--neon2);margin-bottom:1.2rem;">Create Channel</h2>
        <form id="createChannelForm" style="display:flex;flex-direction:column;gap:1.1rem;">
          <label style="font-size:1.01rem;font-weight:600;">Channel Name</label>
          <input id="createChannelName" type="text" required maxlength="32" placeholder="e.g. general" style="width:100%;padding:0.7rem 1rem;border-radius:7px;border:1.5px solid var(--neon2);background:var(--sidebar2-bg);color:var(--text);font-size:1.05rem;">
          <label style="font-size:1.01rem;font-weight:600;">Type</label>
          <select id="createChannelType" style="width:100%;padding:0.7rem 1rem;border-radius:7px;border:1.5px solid var(--neon2);background:var(--sidebar2-bg);color:var(--text);font-size:1.05rem;">
            <option value="text">Text</option>
            <option value="voice">Voice</option>
          </select>
          <button type="submit" style="padding:0.8rem 1.2rem;font-size:1.1rem;background:var(--neon2);color:#fff;border:none;border-radius:8px;cursor:pointer;">Create Channel</button>
        </form>
        <div id="createChannelMsg" style="margin-top:1.2rem;font-size:1.01rem;"></div>
      </div>
    `;
    document.body.appendChild(modal);
    const form = modal.querySelector('#createChannelForm');
    form.onsubmit = async (e) => {
        e.preventDefault();
        const name = modal.querySelector('#createChannelName').value.trim();
        const type = modal.querySelector('#createChannelType').value;
        const msg = modal.querySelector('#createChannelMsg');
        if (!name) return;
        msg.textContent = 'Creating channel...';
        msg.style.color = 'var(--neon2)';
        try {
            const { error } = await supabase
                .from('channels')
                .insert([{ server_id: currentServerId, name, type, created_at: new Date().toISOString() }]);
            if (error) throw error;
            msg.textContent = 'Channel created!';
            msg.style.color = 'var(--success)';
            setTimeout(() => { document.getElementById('createChannelModal').remove(); loadChannels(currentServerId); }, 1200);
        } catch (err) {
            msg.textContent = 'Error: ' + (err.message || 'Could not create channel');
            msg.style.color = 'var(--danger)';
        }
    };
}

// --- Add Server Modal (UI only) ---
function openAddServerModal() {
    if (document.getElementById('addServerModal')) return;
    const modal = document.createElement('div');
    modal.id = 'addServerModal';
    modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(20,20,30,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div style="background:var(--glass);padding:2.5rem 2rem;border-radius:18px;box-shadow:0 8px 40px #000b;min-width:340px;max-width:90vw;position:relative;">
        <button onclick="document.getElementById('addServerModal').remove()" style="position:absolute;top:18px;right:24px;background:none;border:none;font-size:1.5rem;color:var(--neon2);cursor:pointer;">&times;</button>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:1.3rem;color:var(--neon2);margin-bottom:1.2rem;">Add a Server</h2>
        <div id="addServerTabs" style="display:flex;gap:1.2rem;margin-bottom:1.5rem;">
          <button id="tabCreateServer" style="flex:1;padding:0.7rem 0;font-size:1.05rem;background:var(--neon2);color:#fff;border:none;border-radius:8px;cursor:pointer;">Create</button>
          <button id="tabJoinServer" style="flex:1;padding:0.7rem 0;font-size:1.05rem;background:var(--glass);color:var(--neon2);border:1.5px solid var(--neon2);border-radius:8px;cursor:pointer;">Join</button>
        </div>
        <form id="createServerForm" style="display:block;flex-direction:column;gap:1.1rem;">
          <label style="font-size:1.01rem;font-weight:600;">Server Name</label>
          <input id="createServerName" type="text" required maxlength="32" placeholder="e.g. My Gaming Server" style="width:100%;padding:0.7rem 1rem;border-radius:7px;border:1.5px solid var(--neon2);background:var(--sidebar2-bg);color:var(--text);font-size:1.05rem;margin-bottom:1.1rem;">
          <label style="font-size:1.01rem;font-weight:600;">Server Icon <span style='color:var(--neon2);font-size:0.95em;'>(optional, PNG/JPG/SVG, max 2MB)</span></label>
          <input id="createServerIcon" type="file" accept="image/png,image/jpeg,image/svg+xml" style="width:100%;padding:0.5rem 0.2rem;margin-bottom:1.1rem;">
          <button type="submit" style="padding:0.8rem 1.2rem;font-size:1.1rem;background:var(--neon2);color:#fff;border:none;border-radius:8px;cursor:pointer;">Create Server</button>
        </form>
        <form id="joinServerForm" style="display:none;flex-direction:column;gap:1.1rem;">
          <label style="font-size:1.01rem;font-weight:600;">Invite Code</label>
          <input id="joinServerCode" type="text" required maxlength="16" placeholder="Enter invite code" style="width:100%;padding:0.7rem 1rem;border-radius:7px;border:1.5px solid var(--neon2);background:var(--sidebar2-bg);color:var(--text);font-size:1.05rem;margin-bottom:1.1rem;">
          <button type="submit" style="padding:0.8rem 1.2rem;font-size:1.1rem;background:var(--neon2);color:#fff;border:none;border-radius:8px;cursor:pointer;">Join Server</button>
        </form>
        <div id="addServerMsg" style="margin-top:1.2rem;font-size:1.01rem;"></div>
        <div id="inviteCodeBox" style="display:none;margin-top:1.5rem;text-align:center;"></div>
      </div>
    `;
    document.body.appendChild(modal);

    // Tab switching
    const tabCreate = modal.querySelector('#tabCreateServer');
    const tabJoin = modal.querySelector('#tabJoinServer');
    const createForm = modal.querySelector('#createServerForm');
    const joinForm = modal.querySelector('#joinServerForm');
    tabCreate.onclick = () => {
      tabCreate.style.background = 'var(--neon2)';
      tabCreate.style.color = '#fff';
      tabJoin.style.background = 'var(--glass)';
      tabJoin.style.color = 'var(--neon2)';
      createForm.style.display = 'block';
      joinForm.style.display = 'none';
    };
    tabJoin.onclick = () => {
      tabJoin.style.background = 'var(--neon2)';
      tabJoin.style.color = '#fff';
      tabCreate.style.background = 'var(--glass)';
      tabCreate.style.color = 'var(--neon2)';
      createForm.style.display = 'none';
      joinForm.style.display = 'block';
    };

    // --- Create Server Logic ---
    createForm.onsubmit = async (e) => {
      e.preventDefault();
      const name = modal.querySelector('#createServerName').value.trim();
      const iconFile = modal.querySelector('#createServerIcon').files[0];
      if (!name) return;
      const msg = modal.querySelector('#addServerMsg');
      msg.textContent = 'Creating server...';
      msg.style.color = 'var(--neon2)';
      // Generate invite code
      const inviteCode = Math.random().toString(36).substring(2, 10).toUpperCase();
      let iconUrl = null;
      try {
        // Insert server (without icon_url for now)
        const { data: server, error: serverErr } = await supabase
          .from('servers')
          .insert([{ name, invite_code: inviteCode, created_at: new Date().toISOString() }])
          .select()
          .single();
        if (serverErr) throw serverErr;
        // Upload icon if provided
        if (iconFile) {
          const ext = iconFile.name.split('.').pop().toLowerCase();
          const filePath = `server-icons/${server.id}.${ext}`;
          const { data: uploadData, error: uploadErr } = await supabase.storage.from('server-assets').upload(filePath, iconFile, { upsert: true, contentType: iconFile.type });
          if (uploadErr) throw uploadErr;
          // Get public URL
          const { data: urlData } = supabase.storage.from('server-assets').getPublicUrl(filePath);
          iconUrl = urlData.publicUrl;
          // Update server with icon_url
          await supabase.from('servers').update({ icon_url: iconUrl }).eq('id', server.id);
        }
        // Add user as owner
        const { error: memberErr } = await supabase
          .from('server_members')
          .insert([{ user_id: user.id, server_id: server.id, role: 'owner', joined_at: new Date().toISOString() }]);
        if (memberErr) throw memberErr;
        msg.textContent = 'Server created!';
        msg.style.color = 'var(--success)';
        // Show invite code
        const inviteBox = modal.querySelector('#inviteCodeBox');
        inviteBox.style.display = 'block';
        inviteBox.innerHTML = `<div style=\"font-size:1.1rem;color:var(--neon2);margin-bottom:0.7rem;\">Invite Code:</div><div style=\"font-size:1.5rem;font-family:'Orbitron',sans-serif;letter-spacing:2px;background:var(--sidebar2-bg);padding:0.7rem 1.2rem;border-radius:8px;display:inline-block;\">${inviteCode}</div><br><button id=\"copyInviteBtn\" style=\"margin-top:0.7rem;padding:0.5rem 1.2rem;font-size:1.01rem;background:var(--neon2);color:#fff;border:none;border-radius:8px;cursor:pointer;\"><i class=\"fas fa-copy\"></i> Copy</button>`;
        inviteBox.querySelector('#copyInviteBtn').onclick = () => {
          navigator.clipboard.writeText(inviteCode);
          inviteBox.querySelector('#copyInviteBtn').textContent = 'Copied!';
          setTimeout(() => { inviteBox.querySelector('#copyInviteBtn').innerHTML = '<i class=\"fas fa-copy\"></i> Copy'; }, 1200);
        };
        setTimeout(() => { document.getElementById('addServerModal').remove(); loadServers(); }, 3200);
      } catch (err) {
        msg.textContent = 'Error: ' + (err.message || 'Could not create server');
        msg.style.color = 'var(--danger)';
      }
    };

    // --- Join Server Logic ---
    joinForm.onsubmit = async (e) => {
      e.preventDefault();
      const code = modal.querySelector('#joinServerCode').value.trim().toUpperCase();
      if (!code) return;
      const msg = modal.querySelector('#addServerMsg');
      msg.textContent = 'Joining server...';
      msg.style.color = 'var(--neon2)';
      try {
        // Find server by invite code
        const { data: server, error: findErr } = await supabase
          .from('servers')
          .select('id')
          .eq('invite_code', code)
          .single();
        if (findErr || !server) throw new Error('Invalid invite code');
        // Add user as member (role: member)
        const { error: memberErr } = await supabase
          .from('server_members')
          .insert([{ user_id: user.id, server_id: server.id, role: 'member', joined_at: new Date().toISOString() }]);
        if (memberErr) throw memberErr;
        msg.textContent = 'Joined server!';
        msg.style.color = 'var(--success)';
        setTimeout(() => { document.getElementById('addServerModal').remove(); loadServers(); }, 1200);
      } catch (err) {
        msg.textContent = 'Error: ' + (err.message || 'Could not join server');
        msg.style.color = 'var(--danger)';
      }
    };
}

// --- View Invite Code Modal ---
function openInviteCodeModal(serverId) {
    if (document.getElementById('inviteCodeModal')) return;
    const server = servers.find(s => s.id === serverId);
    if (!server) return;
    const modal = document.createElement('div');
    modal.id = 'inviteCodeModal';
    modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(20,20,30,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div style="background:var(--glass);padding:2.2rem 2rem;border-radius:18px;box-shadow:0 8px 40px #000b;min-width:320px;max-width:90vw;position:relative;">
        <button onclick="document.getElementById('inviteCodeModal').remove()" style="position:absolute;top:18px;right:24px;background:none;border:none;font-size:1.5rem;color:var(--neon2);cursor:pointer;">&times;</button>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:1.2rem;color:var(--neon2);margin-bottom:1.2rem;">Server Invite Code</h2>
        <div style="font-size:1.1rem;color:var(--neon2);margin-bottom:0.7rem;">${server.name}</div>
        <div style="font-size:1.5rem;font-family:'Orbitron',sans-serif;letter-spacing:2px;background:var(--sidebar2-bg);padding:0.7rem 1.2rem;border-radius:8px;display:inline-block;">${server.invite_code}</div><br>
        <button id="copyInviteBtn2" style="margin-top:0.7rem;padding:0.5rem 1.2rem;font-size:1.01rem;background:var(--neon2);color:#fff;border:none;border-radius:8px;cursor:pointer;"><i class="fas fa-copy"></i> Copy</button>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#copyInviteBtn2').onclick = () => {
      navigator.clipboard.writeText(server.invite_code);
      modal.querySelector('#copyInviteBtn2').textContent = 'Copied!';
      setTimeout(() => { modal.querySelector('#copyInviteBtn2').innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 1200);
    };
}

function serverIsOwned(serverId) {
    // Check if user is owner of this server
    // (Assumes you have a way to check role in servers array or fetch it)
    // For now, always return true for demo; replace with real check if needed
    return true;
}

// --- On Load ---
window.addEventListener('DOMContentLoaded', loadServers);
</script>
</body>
</html> 